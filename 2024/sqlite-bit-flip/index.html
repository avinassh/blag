<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.138.0"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://avi.im/blag/2024/sqlite-bit-flip/"><title>PSA: SQLite does not do checksums - blag</title>
<meta property="og:title" content="PSA: SQLite does not do checksums - blag"><meta property="og:type" content="article"><meta property="og:description" content="SQLite does not do checksums by default. Disk corruptions go silently unnoticed."><meta name=description content="SQLite does not do checksums by default. Disk corruptions go silently unnoticed."><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=/blag/css/highlight.css><link rel=stylesheet href=/blag/css/journal.css><link href=/blag/index.xml rel=alternate type=application/rss+xml title=blag></head><body><div class=container><div class=site-header-nav><nav class=site-nav><a href=https://avi.im/blag/>Index</a></nav><div><span><a href=/blag/about>About</a></span>
<span><a href=/blag/now>Now</a></span></div></div><article class=post><header class=post-header><h1 class=post-title>PSA: SQLite does not do checksums</h1><time class=post-date datetime="2024-11-09 12:56:46 +0530">09 Nov 2024</time></header><p>SQLite does not do checksums by default. I learned this from <a href=https://fosstodon.org/@AlexMillerDB/109553692861357766>Alex Miller</a>. What does this mean? If there is disk corruption, the database or application won&rsquo;t be able to know that the database is &lsquo;corrupt&rsquo;.</p><p>Even a single bit flip can cause havoc. This can happen due to a faulty disk, a bug in the disk driver, or when another application (malicious or otherwise) modifies the database files.</p><p>This is not a bug - it&rsquo;s properly documented:</p><blockquote><p>SQLite assumes that the detection and/or correction of bit errors caused by cosmic rays, thermal noise, quantum fluctuations, device driver bugs, or other mechanisms, is the responsibility of the underlying hardware and operating system. SQLite does not add any redundancy to the database file for the purpose of detecting corruption or I/O errors. SQLite assumes that the data it reads is exactly the same data that it previously wrote.</p></blockquote><p>I created a <a href=https://gist.github.com/avinassh/0e7e4b0578136a338f1b9a03fba36ead>simple script</a> to demonstrate this:</p><ol><li><p>Create a sample database using <a href=https://gist.github.com/avinassh/0e7e4b0578136a338f1b9a03fba36ead>this script</a>. It creates a bank database and adds a row for Alice with $83K.</p></li><li><p>Flip a single bit:</p><pre><code> printf '\x00\x00\x00\x00\x00\x80' | dd of=bank.db bs=1 seek=$((0x1ffd)) count=1 conv=notrunc
</code></pre></li><li><p>Alice&rsquo;s balance is now zero. Sorry, Alice.</p></li></ol><p>It passes <code>PRAGMA integrity_check</code> too. Here&rsquo;s an ASCII animation if you prefer that:</p><script src=https://asciinema.org/a/688119.js id=asciicast-688119 async></script><h2 id=wal-and-checksums>WAL and Checksums</h2><p>SQLite has checksums for WAL frames. However, when it detects a corrupt frame, it silently ignores the faulty frame and all subsequent frames. It doesn&rsquo;t even raise an error!</p><p>Ignoring frames might be acceptable, but not raising an error is where it gets me.</p><h2 id=checksum-vfs-shim>Checksum VFS Shim</h2><p>You can use the <a href=https://www.sqlite.org/cksumvfs.html>Checksum VFS Shim</a>, but there&rsquo;s one important caveat:</p><blockquote><p>Checksumming only works on databases that have a reserve bytes value of exactly 8</p></blockquote><p>The <a href=https://www.sqlite.org/fileformat2.html#resbyte>documentation of reserve bytes</a> explains:</p><blockquote><p>SQLite has the ability to set aside a small number of extra bytes at the end of every page for use by extensions. These extra bytes are used, for example, by the SQLite Encryption Extension to store a nonce and/or cryptographic checksum associated with each page. The &ldquo;reserved space&rdquo; size in the 1-byte integer at offset 20 is the number of bytes of space at the end of each page to reserve for extensions. This value is usually 0. The value can be odd.</p></blockquote><p>This means if you&rsquo;re using any extension that uses reserve bytes, you can&rsquo;t use the Checksum shim.</p><p>Again, this is not a bug. <a href=https://avi.im/blag/2024/databases-checksum>Most databases (except a few)</a> assume that the OS, filesystem, and disk are sound. Whether this matters depends on your application and the guarantees you need.</p><p>edit: I wrote a <a href=https://avi.im/blag/2024/databases-checksum>follow up post</a>.</p></article><script async data-uid=0576bb9e32 src=https://avin.ck.page/0576bb9e32/index.js></script><footer class=site-footer><div class=rc-scout style=margin-right:auto;margin-top:auto;font-size:.6rem></div><script async defer src="https://www.recurse-scout.com/loader.js?t=a4aabd5087bb19daf083302de1b46650"></script><span class=person-schema itemscope itemtype=http://schema.org/Person><link itemprop=url href=https://avi.im/blag/><span itemprop=name></span><br><a itemprop=sameAs href=https://github.com/avinassh title=GitHub><img src=/blag/svg/gh.svg alt="icon name"></a>
<a itemprop=sameAs href=/blag/index.xml title=GitHub><img src=/blag/svg/rss.svg alt="icon name"></a></span></footer></div><script src=/blag/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script data-goatcounter=https://avi.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>