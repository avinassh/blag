<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.139.4"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://avi.im/blag/2025/sqlite-wal-checksum/"><title>PSA: SQLite WAL checksums fail silently and may lose data - blag</title>
<meta property="og:title" content="PSA: SQLite WAL checksums fail silently and may lose data - blag"><meta property="og:type" content="article"><meta property="og:description" content="SQLite WAL has checksums, but on corruption it drops all the data and does not raise error"><meta name=description content="SQLite WAL has checksums, but on corruption it drops all the data and does not raise error"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=/blag/css/highlight.css><link rel=stylesheet href=/blag/css/journal.css><link href=/blag/index.xml rel=alternate type=application/rss+xml title=blag></head><body><div class=container><div class=site-header-nav><nav class=site-nav><a href=https://avi.im/blag/>Index</a></nav><div><span><a href=/blag/about>About</a></span>
<span><a href=/blag/now>Now</a></span></div></div><article class=post><header class=post-header><h1 class=post-title>PSA: SQLite WAL checksums fail silently and may lose data</h1><time class=post-date datetime="2025-07-22 18:54:26 +0530">22 Jul 2025</time></header><p>This is a follow-up post to my <a href=https://avi.im/blag/2024/sqlite-bit-flip>PSA: SQLite does not do checksums</a> and <a href=https://avi.im/blag/2024/databases-checksum>PSA: Most databases do not do checksums by default</a>. In the previous posts I mentioned that SQLite does not do checksums by default, but it has checksums in WAL mode. However, on checksum errors, instead of raising error, it drops all the subsequent frames. Even if they are not corrupt. This is not a bug; it&rsquo;s intentional.</p><h2 id=sqlite-wal>SQLite WAL</h2><p>SQLite introduced WAL in 2010. It’s not the default mode, but you’re likely using it if you want higher write throughput. Whenever you make writes, they are first written to the WAL file. Then, during checkpoint operations, the database pages are written from the WAL to the main DB file. Each page in the WAL is called a frame. Each frame has a header, which comprises the frame number, page number, commit marker, and checksums.</p><img src=/blag/images/2025/sqlite-frame.svg alt="SQLite Frame" style=width:80%><p>The way checksums work in WAL is interesting. They use rolling checksums, meaning the checksum of the n+1 frame is computed with the checksum of the nth frame. In other words, a frame&rsquo;s checksum depends on the previous frame.</p><img src=/blag/images/2025/sqlite-rolling-checksums.svg alt="SQLite Rolling Checksum" style=width:80%><h2 id=recovery>Recovery</h2><p>If one frame is found to have a checksum mismatch, you can&rsquo;t be sure that the next frame isn&rsquo;t corrupted either. What&rsquo;s interesting is that when a frame is found to have a missing or invalid checksum, SQLite drops that frame and all the subsequent frames. This is <a href=https://www.sqlite.org/walformat.html#recovery>documented</a>:</p><blockquote><p>Recovery works by doing a single pass over the WAL, from beginning to end. The checksums are verified on each frame of the WAL as it is read. The scan stops at the end of the file or at the first invalid checksum. The mxFrame field is set to the index of the last valid commit frame in WAL.</p></blockquote><p>Earlier I mentioned SQLite does not do checksums by default, so it won’t ever notice if a page is corrupt. So when is WAL checksum verification triggered? A WAL may contain multiple frames for the same page number. To make lookups faster, SQLite maintains an index called the WAL Index. This is the <code>.db-shm</code> file you often see. During the building of this index, SQLite checks the checksums.</p><p>You can verify this in the code as well. The recovery process happens in <a href=https://github.com/sqlite/sqlite/blob/version-3.50.3/src/wal.c#L1384><code>walIndexRecover</code></a>, this calls <a href=https://github.com/sqlite/sqlite/blob/version-3.50.3/src/wal.c#L1000><code>walDecodeFrame</code></a> which has this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* A frame is only valid if a checksum of the WAL header,
</span></span></span><span style=display:flex><span><span style=color:#75715e>** all prior frames, the first 16 bytes of this frame-header,
</span></span></span><span style=display:flex><span><span style=color:#75715e>** and the frame-data matches the checksum in the last 8
</span></span></span><span style=display:flex><span><span style=color:#75715e>** bytes of this frame-header.
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>nativeCksum <span style=color:#f92672>=</span> (pWal<span style=color:#f92672>-&gt;</span>hdr.bigEndCksum<span style=color:#f92672>==</span>SQLITE_BIGENDIAN);
</span></span><span style=display:flex><span><span style=color:#a6e22e>walChecksumBytes</span>(nativeCksum, aFrame, <span style=color:#ae81ff>8</span>, aCksum, aCksum);
</span></span><span style=display:flex><span><span style=color:#a6e22e>walChecksumBytes</span>(nativeCksum, aData, pWal<span style=color:#f92672>-&gt;</span>szPage, aCksum, aCksum);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>( aCksum[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>!=</span><span style=color:#a6e22e>sqlite3Get4byte</span>(<span style=color:#f92672>&amp;</span>aFrame[<span style=color:#ae81ff>16</span>])
</span></span><span style=display:flex><span> <span style=color:#f92672>||</span> aCksum[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>!=</span><span style=color:#a6e22e>sqlite3Get4byte</span>(<span style=color:#f92672>&amp;</span>aFrame[<span style=color:#ae81ff>20</span>])
</span></span><span style=display:flex><span>){
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* Checksum failed. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To trigger this issue, the following needs to happen:</p><ol><li>You have SQLite <code>.db</code> and <code>.db-wal</code> files, but no accompanying <code>.db-shm</code> file. Maybe your friend shared it with you, or you downloaded some data off the internet.</li><li>Unclean shutdown during WAL write. The WAL index is updated after a successful write. Maybe after the WAL write, the process crashed, and the index wasn&rsquo;t updated. On the next start, SQLite rebuilds the index.</li></ol><p>During this process, if there&rsquo;s a checksum mismatch on a frame, that frame and the rest of the WAL frames are dropped. Even if they are not corrupt (technically)! Note that SQLite always checkpoints and truncates the WAL file on the last connection close.</p><h2 id=demo>Demo</h2><img src=/blag/images/2025/sqlite-wal-checksum.gif><p>Alice would have lost money, <a href=https://avi.im/blag/2024/sqlite-bit-flip>again</a>. Poor Alice.</p><h2 id=thoughts>Thoughts</h2><ol><li>I really don’t like that SQLite doesn’t throw any error on detection of corruption</li><li>Since it automatically checkpoints every time, the data is lost too</li></ol><p>I’m not sure why this is the default behavior. Backward compatibility reasons? The checksums in WAL are likely not meant to check for random page corruption in the middle; maybe they’re just to check if the last write of a frame was fsynced properly or not?</p><p>What I want: throw an error when corruption is detected and let the code handle it. Don’t checkpoint and truncate the WAL! Maybe provide an option for users to opt in to ignore the corruption and work with the existing behavior.</p><p>In the demo, I corrupted a frame that belonged to an older version of a page. Meaning no new transactions can ever read that data. That frame is practically useless, yet it caused data loss. There are pages like belonging to an index or maybe some table that we don’t care about at all. With sophisticated recovery mechanisms, we could sometimes able to recover all the data.</p><p>Overall, I don’t like this as a default. However, <a href=https://x.com/penberg>Pekka Enberg</a> offered a different perspective that SQLite runs in embedded environments where there’s no server, and maybe core developers decided it may be better to limp along than crash.</p><p>I would guess that other databases behave the same way, but I haven’t verified it myself. I was discussing this with <a href=https://transactional.blog>Alex Miller</a>, and he raised an interesting point: SQLite mostly runs on mobile devices with cheap SD cards (as opposed to running on enterprise-grade SSDs), and corruptions are more common. So, it’s more important for SQLite to have corruption detection than other databases.</p></article><script async data-uid=0576bb9e32 src=https://avin.ck.page/0576bb9e32/index.js></script><footer class=site-footer><div class=rc-scout style=margin-right:auto;margin-top:auto;font-size:.6rem></div><script async defer src="https://www.recurse-scout.com/loader.js?t=a4aabd5087bb19daf083302de1b46650"></script><span class=person-schema itemscope itemtype=http://schema.org/Person><link itemprop=url href=https://avi.im/blag/><span itemprop=name></span><br><a itemprop=sameAs href=https://github.com/avinassh title=GitHub><img src=/blag/svg/gh.svg alt="icon name"></a>
<a itemprop=sameAs href=/blag/index.xml title=GitHub><img src=/blag/svg/rss.svg alt="icon name"></a></span></footer></div><script src=/blag/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script data-goatcounter=https://avi.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>