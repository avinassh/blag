<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=generator content="Hugo 0.89.1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content>
<meta property="og:url" content="https://avi.im/blag/2021/mongo-dupes-in-unique-index/">
<title>I ended up adding duplicate records on a unique index in MongoDB - blag</title>
<meta property="og:title" content="I ended up adding duplicate records on a unique index in MongoDB - blag">
<meta property="og:type" content="article">
<meta property="og:image" content="https://avi.im/blag/images/2021/mongo-unique-index-oops.png">
<meta property="og:image:secure_url" content="https://avi.im/blag/images/2021/mongo-unique-index-oops.png">
<meta property="og:description" content="how my curiosity lead me to discover a weird inconsistency with MongoDB where I was able to insert records that conflicted the index constraints">
<meta name=description content="how my curiosity lead me to discover a weird inconsistency with MongoDB where I was able to insert records that conflicted the index constraints">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700">
<link rel=stylesheet href=/blag/css/highlight.css>
<link rel=stylesheet href=/blag/css/journal.css>
<link href=/blag/index.xml rel=alternate type=application/rss+xml title=blag>
</head>
<body>
<div class=container>
<div class=site-header-nav>
<nav class=site-nav>
<a href=https://avi.im/blag>Index</a>
</nav>
<div>
<span><a href=/blag/about>About</a></span>
<span><a href=/blag/projects>Projects</a></span>
<span><a href=https://avi.im/resume.pdf>Resume</a></span>
<span><a href=https://tinyletter.com/avi-im>Subscribe</a></span>
</div>
</div>
<article class=post>
<header class=post-header>
<h1 class=post-title>I ended up adding duplicate records on a unique index in MongoDB</h1>
<time class=post-date datetime="2021-03-31 19:51:35 +0530">31 Mar 2021</time>
</header>
<p><small>Note: The intention of this post is not to shit on MongoDB. They specifically forbid the steps I am about to explain. This post is a chronicle of my curiosity, exploration, and fun learning experience. If you still find it interesting, then continue to read on (:</small></p>
<p>In MongoDB (or generally in any database), the following rules apply when it comes to the unique indexes:</p>
<ol>
<li>You cannot add duplicate records which violate the unique constraints</li>
<li>If there is a collection that has duplicate records, then you cannot add a unique index to the collection unless you delete those dupes first</li>
</ol>
<p>Yet, I ended up breaking these set rules and bringing my MongoDB in a weird state in which:</p>
<ol>
<li>The secondary was replicating from the primary with data which conflicted the unique index constraints (breaking the rule 1)</li>
<li>I was able to have a unique index with data that conflicted the unique constraints (breaking the rule 2)</li>
</ol>
<h2 id=the-problem>The Problem</h2>
<p>I have a three node cluster, with a primary and two secondaries. If you want to create an index on a large collection, MongoDB docs suggest you do something called <a href=https://docs.mongodb.com/v4.0/tutorial/build-indexes-on-replica-sets/>Rolling Index Builds</a>:</p>
<ol>
<li>Remove a member from the replica set</li>
<li>Create the index</li>
<li>Add the follower back to the replica set</li>
<li>Repeat for all the followers</li>
<li>Make the primary to step down and let some other followers become the primary</li>
<li>Then create the index on the last remaining follower (the earlier primary)</li>
</ol>
<p>However, these steps change when you want to create a unique index. The Mongo docs specifically highlight this:</p>
<blockquote>
<p>To create <a href=https://docs.mongodb.com/v4.0/core/index-unique/#index-type-unique>unique indexes</a> using the following procedure, you must stop all writes to the collection during this procedure.</p>
<p>If you cannot stop all writes to the collection during this procedure, do not use the procedure on this page. Instead, build your unique index on the collection by issuing <a href=https://docs.mongodb.com/v4.0/reference/method/db.collection.createIndex/#db.collection.createIndex>db.collection.createIndex()</a> on the primary for a replica set.</p>
</blockquote>
<p>Mongo has two modes of creating indexes:</p>
<ol>
<li>Foreground: This uses more efficient data structures, but this <a href=https://docs.mongodb.com/v4.0/faq/indexes/#how-does-an-index-build-affect-database-performance>blocks all read, write operations</a> on the collection while the index is being built. This is not good if you don&rsquo;t want to have downtime. There are <a href=https://docs.mongodb.com/v4.0/reference/parameters/#param.maxIndexBuildMemoryUsageMegabytes>ways to speed this process up</a>, but Mongo index creation process is <a href=https://jira.mongodb.org/browse/SERVER-676>single threaded</a>. Ouch.</li>
<li>Background: This runs in the background, but uses an inefficient index data structure and also, this is very very slow. No way to speed this up.</li>
</ol>
<p>I measured and both of them were terrible. Foreground mode took about 3 hours (with the maximum RAM I could add in Google Cloud). Background indexing took about 18 hours on a single replica. The constraints apply only when the index is fully built. During the index creation if dupes get inserted, then the whole <a href=https://docs.mongodb.com/v4.0/core/index-creation/#interrupted-index-builds>index process will be aborted</a> and needs to be restarted again. (The older version of Mongo had a nice option of specifying dropping the dupes during index creation.)</p>
<p>I disliked both and I was tempted to try the Rolling Index builds for the unique indexes, the very thing which Mongo docs forbade. The docs said &lsquo;do not do this&rsquo;, but did not say what would happen if someone did it. Of course, I had to take one for the team and try it.</p>
<h2 id=the-anti-solution>The (Anti) Solution</h2>
<p>I diligently followed the instructions given <a href=https://docs.mongodb.com/v4.0/tutorial/build-indexes-on-replica-sets/#a-stop-one-secondary-and-restart-as-a-standalone>here</a> and took out one of the followers. This was simple, I had to change the mongod config (usually located at <code>/etc/mongod.conf</code>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>net</span>:
   <span style=color:#f92672>bindIp</span>: <span style=color:#ae81ff>localhost</span>
   <span style=color:#f92672>port</span>: <span style=color:#ae81ff>27217</span>
<span style=color:#75715e>#   port: 27017</span>
<span style=color:#75715e>#replication:</span>
<span style=color:#75715e>#   replSetName: myRepl</span>
<span style=color:#f92672>setParameter</span>:
   <span style=color:#f92672>disableLogicalSessionCacheRefresh</span>: <span style=color:#66d9ef>true</span>
<span style=color:#ae81ff>// snipped conf file</span>
</code></pre></div><p>Then I built an unique index on a collection:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>createIndex</span>({<span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>}, {<span style=color:#a6e22e>unique</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>})
{
	<span style=color:#e6db74>&#34;createdCollectionAutomatically&#34;</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
	<span style=color:#e6db74>&#34;numIndexesBefore&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
	<span style=color:#e6db74>&#34;numIndexesAfter&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>,
	<span style=color:#e6db74>&#34;ok&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>
}
</code></pre></div><p>While the index was being built, I inserted a duplicate document in the primary. Since primary did not have any indexes, it happily obliged to my commands:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>rs0</span><span style=color:#f92672>:</span><span style=color:#a6e22e>PRIMARY</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>insert</span>({<span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span>})
<span style=color:#a6e22e>WriteResult</span>({ <span style=color:#e6db74>&#34;nInserted&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> })
</code></pre></div><p>I undid the conf file changes in the secondary and added it back to the replica set, crossed my fingers, and asked my friends to guess what would happen:</p>
<ol>
<li>The new follower would be rejected because it has an index which primary isn&rsquo;t aware of</li>
<li>The unrecognised index would be dropped silently from the secondary</li>
<li>The replication will be failing in a loop whenever it encountered the duplicate record from the primary</li>
<li>The replication would complete successfully, dropping the duplicate records silently</li>
</ol>
<p>But, as you have guessed already, none of these things happened. The follower was welcomed into the replica set and replication completed successfully. I first checked the primary, if there were any new indexes. Rightly so, there were none. I checked the secondary if the unique index had gotten dropped. But nope.</p>
<p>Then the following blew my mind:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>rs0</span><span style=color:#f92672>:</span><span style=color:#a6e22e>SECONDARY</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>getIndexes</span>()
{ <span style=color:#e6db74>&#34;v&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;unique&#34;</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;key&#34;</span> <span style=color:#f92672>:</span> { <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> }, <span style=color:#e6db74>&#34;name&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user_1&#34;</span> }
<span style=color:#75715e>// snipped output
</span><span style=color:#75715e></span><span style=color:#a6e22e>rs0</span><span style=color:#f92672>:</span><span style=color:#a6e22e>SECONDARY</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>find</span>()
{ <span style=color:#e6db74>&#34;_id&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>ObjectId</span>(<span style=color:#e6db74>&#34;6066e0f278d5455b08f3920b&#34;</span>), <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span> }
{ <span style=color:#e6db74>&#34;_id&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>ObjectId</span>(<span style=color:#e6db74>&#34;6066e80385a02d98945e380e&#34;</span>), <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span> }
</code></pre></div><p>Then I forced this particular secondary to become the primary. The index existed and it wasn&rsquo;t replicated to other nodes, as expected. When I tried to insert dupes, it failed:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>insert</span>({<span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span>})
<span style=color:#a6e22e>WriteResult</span>({
	<span style=color:#e6db74>&#34;nInserted&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
	<span style=color:#e6db74>&#34;writeError&#34;</span> <span style=color:#f92672>:</span> {
		<span style=color:#e6db74>&#34;code&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>11000</span>,
		<span style=color:#e6db74>&#34;errmsg&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;E11000 duplicate key error collection: users.records index: user_1 dup key: { : \&#34;avi\&#34; }&#34;</span>
	}
})
</code></pre></div><p>I made this new primary step down and I inserted dupes again from the primary. Checked them happily being replicated into the secondary:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>rs0</span><span style=color:#f92672>:</span><span style=color:#a6e22e>SECONDARY</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>find</span>()
{ <span style=color:#e6db74>&#34;_id&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>ObjectId</span>(<span style=color:#e6db74>&#34;6066e0f278d5455b08f3920b&#34;</span>), <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span> }
{ <span style=color:#e6db74>&#34;_id&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>ObjectId</span>(<span style=color:#e6db74>&#34;6066e80385a02d98945e380e&#34;</span>), <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span> }
{ <span style=color:#e6db74>&#34;_id&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>ObjectId</span>(<span style=color:#e6db74>&#34;6066ea3b85a02d98945e380f&#34;</span>), <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;avi&#34;</span> }
<span style=color:#a6e22e>rs0</span><span style=color:#f92672>:</span><span style=color:#a6e22e>SECONDARY</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>records</span>.<span style=color:#a6e22e>getIndexes</span>()
{ <span style=color:#e6db74>&#34;v&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;unique&#34;</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;key&#34;</span> <span style=color:#f92672>:</span> { <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> }, <span style=color:#e6db74>&#34;name&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user_1&#34;</span> }
<span style=color:#75715e>// snipped output
</span></code></pre></div><h3 id=bonus>Bonus</h3>
<script id=asciicast-404598 src=https://asciinema.org/a/404598.js async></script>
<p><small><i>Thanks to Piyush Mishra for reading a draft of this.</i></small></p>
<hr>
<p><small>1. This post references Mongo DB v4.0, the version I was using. However, this behaviour exists in the latest version of v4.4 as well.</small><br>
<small>2. The index creation mechanisms have greatly improved in the newer versions of <a href=https://docs.mongodb.com/v4.2/core/index-creation/>Mongo DB, starting with 4.2</a>.</small></p>
</article>
<form style="border:1px solid #ccc;padding:3px;text-align:center" action=https://tinyletter.com/avi-im method=post target=popupwindow onsubmit="return window.open('https://tinyletter.com/avi-im','popupwindow','scrollbars=yes,width=800,height=600'),!0"><p><label for=tlemail>Enter your email address: </label><input type=text style=width:140px name=email id=tlemail></p><input type=hidden value=1 name=embed><input type=submit value=Subscribe></form>
<footer class=site-footer>
<div class=rc-scout style=margin-right:auto;margin-top:auto;font-size:.6rem></div>
<script async defer src="https://www.recurse-scout.com/loader.js?t=a4aabd5087bb19daf083302de1b46650"></script>
<span class=person-schema itemscope itemtype=http://schema.org/Person>
<link itemprop=url href=https://avi.im/blag>
<span itemprop=name></span>
<br>
<a itemprop=sameAs href=https://github.com/avinassh title=GitHub><img src=/blag/svg/gh.svg alt="icon name"></a>
<a itemprop=sameAs href=/blag/index.xml title=GitHub><img src=/blag/svg/rss.svg alt="icon name"></a>
</span>
</footer>
</div>
<script src=/blag/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<script data-goatcounter=https://avi.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
</body>
</html>